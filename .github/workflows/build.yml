name: CI

on:
  workflow_dispatch:

  issue_comment:
    types: [created]

jobs:
  build-el8stream:
    runs-on: [ self-hosted, image-builders ]
    if: |
      github.event_name == 'workflow_dispatch' ||
      ( github.event.issue.pull_request &&
        startsWith(github.event.comment.body, '/build') &&
        (
          github.event.comment.author_association == 'MEMBER' ||
          github.event.comment.author_association == 'COLLABORATOR'
        )
      )
    container:
      image: quay.io/ovirt/buildcontainer:el9stream
      options: --group-add qemu --user build --privileged

    steps:
    - name: Report back results
      if: ! github.event.issue.pull_request
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd /home/build/ost-images
               MESSAGE="Built images:\n$(for i in rpmbuild/RPMS/x86_64/*.rpm; do echo https://resources.ovirt.org/repos/ovirt/github-ci/ost-images/$(basename $i); done)"
        curl -H "Authorization: Token ${GITHUB_TOKEN}" -X POST -d "{\“body\”: \“${MESSAGE}\”}" https://api.github.com/repos/oVirt/ost-images/issues/28/comments
